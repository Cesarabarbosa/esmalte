<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mapa de Fornos para Queima – Brasil</title>
<meta name="color-scheme" content="light dark">

<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
  integrity="sha512-f3L9h6q5mL0w0ySkV7r8y6uK8Y2F2nFv1mNnK4oA0XJpY1k7vA+Srw4bHnqM2a1k2nF7Yt8uWmB1mW5tR9w3bg=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#f8fafc; --card:#fff; --accent:#2563eb;
  }
  @media (prefers-color-scheme: dark){
    :root{ --ink:#e5e7eb; --muted:#94a3b8; --line:#334155; --bg:#0b1220; --card:#0f172a; --accent:#60a5fa; }
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px}
  header .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button{padding:10px 12px;border:1px solid var(--line);background:var(--card);color:var(--ink);border-radius:10px}
  button{background:var(--accent);color:white;border:none;cursor:pointer}
  button.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
  .container{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;height:calc(100vh - 74px)}
  #sidebar{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:auto}
  #map{border:1px solid var(--line);border-radius:14px}
  .item{padding:12px;border-bottom:1px dashed var(--line);cursor:pointer}
  .item:hover{background:rgba(37,99,235,.06)}
  .small{color:var(--muted);font-size:12px}
  .row .grow{flex:1}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(37,99,235,.1);color:var(--accent);font-size:12px;margin-left:6px}
  .count{margin-left:auto;color:var(--muted);font-size:12px}
  .legend{padding:8px 12px;border-bottom:1px solid var(--line)}
  #status{margin-left:8px;font-size:12px}
  @media (max-width: 900px){
    .container{grid-template-columns:1fr;grid-template-rows:50vh 50vh}
    #map{order:1}
    #sidebar{order:2}
  }
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>Ateliês com fornos para queima</strong>
    <span id="total" class="pill">0 locais</span>
    <span class="count" id="filteredCount"></span>
    <span id="status" class="small"></span>
  </div>
  <div class="row">
    <input id="search" class="grow" type="search" placeholder="Buscar por cidade, nome, UF, observação…" />
    <button id="locate">Usar minha localização</button>
    <label class="small">Raio:
      <select id="radius">
        <option value="10">10 km</option>
        <option value="25">25 km</option>
        <option value="50" selected>50 km</option>
        <option value="100">100 km</option>
        <option value="200">200 km</option>
      </select>
    </label>
    <button class="ghost" id="clearFilters">Limpar filtros</button>
  </div>
</header>

<div class="container">
  <aside id="sidebar">
    <div class="legend small">Toque em um item para centralizar no mapa.</div>
    <div id="list"></div>
  </aside>
  <div id="map"></div>
</div>

<script>
/* ========= CONFIG ========= */
// Use o RAW (CORS liberado). Se colocar o index.html e o CSV na mesma pasta,
// também funciona com: const CSV_PUBLISHED_URL = "./fornosdobrasil.csv";
const CSV_PUBLISHED_URL = "https://raw.githubusercontent.com/Cesarabarbosa/fornos-/main/fornosdobrasil.csv";

/* ========= MAPA ========= */
const map = L.map('map', { zoomControl: true }).setView([-14.2350, -51.9253], 4); // centro Brasil
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);
const markersLayer = L.layerGroup().addTo(map);

let allRows = [];
let currentRows = [];
let userPos = null;

/* ========= UTIL ========= */
const statusEl = document.getElementById('status');

function setStatus(msg, isError=false){
  statusEl.textContent = msg || '';
  statusEl.style.color = isError ? '#b91c1c' : 'inherit';
}

function normalizeKeys(row) {
  const out = {};
  for (const k in row) if (Object.hasOwn(row, k)) out[k.trim().toLowerCase()] = (row[k] ?? '').toString().trim();
  return out;
}

function mapRow(r){
  const nome = r.nome || r["nome do ateliê"] || r.atelie || r.ateliê || r.studio || r.estudio || r.atelier;
  const cidade = r.cidade || r.municipio || r.município;
  const uf = r.uf || r.estado;
  const lat = r.lat || r.latitude;
  const lng = r.lng || r.long || r.longitude;
  const whatsapp = r.whatsapp || r["whats"] || r["whatsapp/telefone"];
  const telefone = r.telefone || r.celular;
  const email = r.email || r.contato;
  const site = ensureHttp(r.site || r.link || r.url);
  const obs = r.obs || r.observacao || r.observações || r.observacoes;
  return {nome,cidade,uf,lat,lng,whatsapp,telefone,email,site,obs};
}

function ensureHttp(url){
  if (!url) return "";
  const u = url.trim();
  if (/^https?:\/\//i.test(u)) return u;
  return "https://" + u;
}

function toNumber(x){
  if (x === null || x === undefined) return null;
  const n = Number(String(x).replace(",", ".").trim());
  return Number.isFinite(n) ? n : null;
}

function stripAccents(s){
  return (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

/* ========= RENDER ========= */
function popupHtml(d){
  const nome = d.nome || 'Ateliê';
  const cidadeUF = [d.cidade, d.uf].filter(Boolean).join(' / ');
  const linhasContato = [d.whatsapp, d.telefone, d.email].filter(Boolean).join(' · ');
  const contato = linhasContato ? `<div class="small">${linhasContato}</div>` : '';
  const site = d.site ? `<div><a href="${d.site}" target="_blank" rel="noopener">Site</a></div>` : '';
  const obs = d.obs ? `<div class="small">${d.obs}</div>` : '';
  return `<div><strong>${nome}</strong><br/><span class="small">${cidadeUF}</span><br/>${contato}${site}${obs}</div>`;
}

function renderMarkers(rows){
  markersLayer.clearLayers();
  const pts = [];
  rows.forEach(r => {
    const lat = toNumber(r.lat), lng = toNumber(r.lng);
    if (lat === null || lng === null) return;
    const m = L.marker([lat, lng]).bindPopup(popupHtml(r));
    m.addTo(markersLayer);
    pts.push([lat, lng]);
  });
  // Ajusta o mapa para caber todos os pinos
  if (pts.length === 1) map.setView(pts[0], 12);
  if (pts.length > 1) map.fitBounds(pts, { padding: [24,24] });
}

function renderList(rows){
  const list = document.getElementById('list');
  list.innerHTML = '';
  rows.forEach(r => {
    const el = document.createElement('div');
    el.className = 'item';
    const cidadeUF = [r.cidade, r.uf].filter(Boolean).join(' / ');
    el.innerHTML = `
      <div><strong>${r.nome || 'Ateliê'}</strong></div>
      <div class="small">${cidadeUF}</div>
      ${r.site ? `<div class="small"><a href="${r.site}" target="_blank" rel="noopener">Abrir site</a></div>` : ''}
    `;
    el.addEventListener('click', () => {
      const lat = toNumber(r.lat), lng = toNumber(r.lng);
      if (lat !== null && lng !== null) {
        map.setView([lat, lng], 13);
        // tenta abrir popup mais recente naquela posição
        const m = L.marker([lat, lng]).bindPopup(popupHtml(r));
        m.addTo(markersLayer).openPopup();
      }
    });
    list.appendChild(el);
  });
  document.getElementById('filteredCount').textContent = rows.length ? `${rows.length} resultado(s)` : 'Nenhum resultado';
}

/* ========= FILTROS ========= */
function applyFilters(){
  const q = stripAccents(document.getElementById('search').value).toLowerCase();
  const radiusKm = Number(document.getElementById('radius').value);
  let rows = allRows;

  if (q){
    rows = rows.filter(r => {
      const blob = stripAccents([
        r.nome, r.cidade, r.uf, r.obs, r.site, r.whatsapp, r.telefone, r.email
      ].filter(Boolean).join(' ')).toLowerCase();
      return blob.includes(q);
    });
  }

  if (userPos){
    rows = rows
      .map(r => {
        const lat = toNumber(r.lat), lng = toNumber(r.lng);
        if (lat === null || lng === null) return { r, dist: Infinity };
        const dist = haversineKm(userPos, {lat, lng});
        return { r, dist };
      })
      .filter(x => x.dist <= radiusKm)
      .sort((a,b) => a.dist - b.dist)
      .map(x => ({ ...x.r, _dist: x.dist.toFixed(1) + ' km' }));
  }

  currentRows = rows;
  renderMarkers(rows);
  renderList(rows);
}

function haversineKm(a, b){
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI/180;
  const dLng = (b.lng - a.lng) * Math.PI/180;
  const la1 = a.lat * Math.PI/180;
  const la2 = b.lat * Math.PI/180;
  const h = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

/* ========= EVENTOS UI ========= */
document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('radius').addEventListener('change', applyFilters);
document.getElementById('clearFilters').addEventListener('click', () => {
  document.getElementById('search').value = '';
  userPos = null;
  setStatus('');
  applyFilters();
});

document.getElementById('locate').addEventListener('click', () => {
  if (!navigator.geolocation) return alert('Geolocalização não suportada.');
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      L.circle([userPos.lat, userPos.lng], {
        radius: Number(document.getElementById('radius').value) * 1000,
        color: '#2563eb',
        fillOpacity: 0.07
      }).addTo(map);
      map.setView([userPos.lat, userPos.lng], 11);
      setStatus('Localização obtida.');
      applyFilters();
    },
    (err) => {
      console.warn(err);
      alert('Não foi possível obter sua localização.');
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
});

/* ========= CARREGAR CSV (com fallback) ========= */
async function loadData(){
  const url = CSV_PUBLISHED_URL + (CSV_PUBLISHED_URL.includes("?") ? "&" : "?") + "v=" + Date.now();

  // 1) Tenta via fetch (erro detalhado + sem cache)
  try {
    setStatus('Carregando dados…');
    const resp = await fetch(url, { cache: "no-store", mode: "cors" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status} – ${resp.statusText}`);
    const text = await resp.text();

    // Se o CSV usar “;”, o Papa geralmente detecta. Se precisar, force delimiter: ";"
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    if (parsed.errors?.length) console.warn("Papa (fetch) errors:", parsed.errors.slice(0,3));
    setStatus('');
    return parsed.data.map(raw => mapRow(normalizeKeys(raw)));
  } catch (e1) {
    console.warn("Fetch falhou, tentando Papa.download:", e1.message || e1);
    // 2) Fallback: Papa com download
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          if (res.errors?.length) console.warn("Papa (download) errors:", res.errors.slice(0,3));
          setStatus('');
          resolve(res.data.map(raw => mapRow(normalizeKeys(raw))));
        },
        error: (err) => {
          setStatus('Falha ao carregar o CSV.', true);
          reject(err);
        }
      });
    });
  }
}

/* ========= BOOT ========= */
(async function init(){
  try{
    allRows = await loadData();
    document.getElementById('total').textContent = `${allRows.length} locais`;
    currentRows = allRows.slice();
    renderMarkers(allRows);
    renderList(allRows);
  }catch(e){
    console.error(e);
    alert('Erro ao carregar o CSV. Verifique o link e se o arquivo está público.');
  }
})();
</script>
</body>
</html>
