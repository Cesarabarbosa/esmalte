<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Busca nos PDFs – Conteúdo das Aulas</title>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; --card:#ffffff;
      --accent:#2563eb; --accent-weak:#dbeafe;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); background:var(--bg)}
    header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    h1{margin:6px 0 10px; font-size:clamp(18px,3vw,24px)}
    .hint{color:var(--muted); font-size:14px}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(2,6,23,.04)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    input[type="search"]{flex:1 1 360px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:16px; outline:none}
    input[type="search"]:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-weak)}
    button{padding:10px 14px; border-radius:10px; border:1px solid var(--accent); background:var(--accent); color:#fff; font-weight:600; cursor:pointer}
    button.secondary{background:#fff; color:var(--accent)}
    .status{font-size:13px; color:var(--muted); margin-top:8px}
    .layout{display:grid; grid-template-columns:1fr 420px; gap:16px; align-items:start}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .results{min-height:120px}
    .card{border:1px solid var(--line); border-radius:12px; padding:12px; margin:10px 0; background:#fff}
    .card h3{margin:0 0 6px; font-size:16px}
    .card a{color:var(--accent); text-decoration:none}
    .meta{font-size:12px; color:var(--muted)}
    .snippet{margin-top:6px; font-size:14px; line-height:1.35}
    mark{background:#fde68a; padding:0 2px; border-radius:4px}
    iframe{width:100%; height:75vh; min-height:420px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--accent-weak); color:var(--accent); font-size:12px; margin-left:8px}
    .small{font-size:12px}
    .progress{height:8px; background:#eff6ff; border-radius:999px; overflow:hidden; margin-top:8px}
    .bar{height:100%; width:0%; background:var(--accent); transition:width .2s}
    .filters{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .chip{border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer}
    .chip.active{border-color:var(--accent); color:var(--accent); background:var(--accent-weak)}
    .muted{color:var(--muted)}
    .foot{padding:16px; text-align:center; color:var(--muted); font-size:12px}
  </style>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" defer></script>
  <script>
    window.addEventListener('load', () => {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    });
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Busca nos PDFs <span class="badge" id="badgeCount">indexando…</span></h1>
      <div class="hint">Digite uma palavra ou frase. Os resultados mostram trechos do texto e levam direto à página correspondente no PDF.</div>
      <div class="panel" style="margin-top:10px">
        <div class="row">
          <input id="q" type="search" placeholder="Ex.: torno, esmalte, argila, barbotina..." />
          <button id="btnSearch">Pesquisar</button>
          <button id="btnClear" class="secondary">Limpar</button>
        </div>
        <div class="filters" id="filters"></div>
        <div class="status" id="status">Preparando indexação…</div>
        <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <section class="panel">
        <div class="row" style="justify-content:space-between; align-items:baseline">
          <h2 style="margin:0; font-size:18px">Resultados</h2>
          <div class="small muted" id="resultCount">—</div>
        </div>
        <div id="results" class="results"></div>
      </section>

      <aside class="panel">
        <h2 style="margin:0 0 8px; font-size:18px">Visualizador</h2>
        <div class="small muted">Ao clicar em um resultado, o PDF abre aqui. Você também pode abrir em nova aba.</div>
        <iframe id="viewer" title="Visualizador de PDF"></iframe>
      </aside>
    </div>
  </main>

  <div class="foot">Para adicionar novos PDFs, edite a lista <code>PDF_LIST</code> abaixo.</div>

<script>
/* ===== 1) LISTA DE PDFs (usando RAW do GitHub) ===== */
const PDF_LIST = [
  {
    title: "Aula de Cerâmica",
    url: "https://raw.githubusercontent.com/Cesarabarbosa/conteudodasaulas/main/pasta/auladeceramica.pdf"
  },
  {
    title: "Esmalte",
    url: "https://raw.githubusercontent.com/Cesarabarbosa/conteudodasaulas/main/pasta/esmalte.pdf"
  },
  {
    title: "Torno",
    url: "https://raw.githubusercontent.com/Cesarabarbosa/conteudodasaulas/main/pasta/torno.pdf"
  }
];
// Se quiser indexar .txt, adicione {title, url, type:'text'}.

/* ===== 2) INDEXAÇÃO ===== */
const state = { pages: [], filterPdfIndex: null, ready: false };

const $ = (s) => document.querySelector(s);
const resultsEl = $('#results'), viewerEl  = $('#viewer'),
      statusEl  = $('#status'),  barEl     = $('#bar'),
      countEl   = $('#resultCount'), badgeEl = $('#badgeCount'),
      filtersEl = $('#filters'),  qEl       = $('#q');

function human(s){ return s.replace(/\s+/g,' ').trim(); }

function renderFilters(){
  filtersEl.innerHTML = '';
  const all = document.createElement('button');
  all.className = 'chip' + (state.filterPdfIndex===null ? ' active':'');
  all.textContent = 'Todos os PDFs';
  all.onclick = () => { state.filterPdfIndex=null; doSearch(); renderFilters(); };
  filtersEl.appendChild(all);

  PDF_LIST.forEach((p, i) => {
    const b = document.createElement('button');
    b.className = 'chip' + (state.filterPdfIndex===i ? ' active':'');
    b.textContent = p.title || `PDF ${i+1}`;
    b.onclick = () => { state.filterPdfIndex = i; doSearch(); renderFilters(); };
    filtersEl.appendChild(b);
  });
}

async function fetchText(url){ const r = await fetch(url); return await r.text(); }

async function indexAll(){
  renderFilters();
  statusEl.textContent = 'Carregando PDFs e extraindo texto…';

  let totalPages = 0, donePages = 0;

  for (let i=0; i<PDF_LIST.length; i++){
    const item = PDF_LIST[i];

    if (item.type === 'text'){
      try{
        const txt = await fetchText(item.url);
        state.pages.push({ pdfIndex:i, pdfTitle:item.title||`Item ${i+1}`, url:item.url, pageNumber:1, text:human(txt) });
      }catch(e){ console.warn('Falha ao ler texto', item.url, e); }
      continue;
    }

    try{
      const loadingTask = pdfjsLib.getDocument({ url: item.url, withCredentials:false });
      const pdf = await loadingTask.promise;
      totalPages += pdf.numPages;

      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const text = human(content.items.map(t => t.str).join(' '));
        state.pages.push({ pdfIndex:i, pdfTitle:item.title||`PDF ${i+1}`, url:item.url, pageNumber:p, text });
        donePages++;
        barEl.style.width = Math.min(100, (donePages / Math.max(1,totalPages))*100) + '%';
      }
    }catch(e){
      console.error('Erro ao processar', item.url, e);
    }
  }

  state.ready = true;
  statusEl.innerHTML = `Indexação concluída. <span class="small">(${state.pages.length} páginas)</span>`;
  badgeEl.textContent = `${state.pages.length} pág. indexadas`;
  barEl.style.width = '100%';
}

/* ===== 3) BUSCA ===== */
function highlight(text, query){
  if (!query) return text;
  try{
    const re = new RegExp('('+escapeRegExp(query)+')','ig');
    return text.replace(re,'<mark>$1</mark>');
  }catch{ return text; }
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

function makeSnippet(full, query, radius=80){
  const pos = full.toLowerCase().indexOf(query.toLowerCase());
  if (pos < 0) return full.slice(0,160) + (full.length>160?'…':'');
  const start = Math.max(0, pos - radius);
  const end   = Math.min(full.length, pos + query.length + radius);
  let snip = (start>0?'…':'') + full.slice(start, end) + (end<full.length?'…':'');
  return highlight(snip, query);
}

function doSearch(){
  const q = qEl.value.trim();
  resultsEl.innerHTML = '';
  if (!q){ countEl.textContent = '—'; return; }
  if (!state.ready){
    resultsEl.innerHTML = `<div class="card"><div class="snippet">Aguarde: ainda indexando os PDFs…</div></div>`;
    return;
  }

  const scope = state.filterPdfIndex===null ? state.pages : state.pages.filter(p => p.pdfIndex===state.filterPdfIndex);
  const re = new RegExp(escapeRegExp(q), 'i');
  const matches = [];

  for (const page of scope){
    if (re.test(page.text)){
      matches.push({ ...page, snippet: makeSnippet(page.text, q) });
    }
  }

  countEl.textContent = `${matches.length} resultado(s)`;
  if (!matches.length){
    resultsEl.innerHTML = `<div class="card"><div class="snippet">Nenhum resultado para <b>${q}</b>.</div></div>`;
    return;
  }

  const frag = document.createDocumentFragment();
  matches.slice(0,300).forEach(m => {
    const el = document.createElement('div');
    el.className = 'card';
    const pageLink = `${m.url}#page=${m.pageNumber}`;
    el.innerHTML = `
      <h3>${m.pdfTitle} <span class="meta">— página ${m.pageNumber}</span></h3>
      <div class="snippet">${m.snippet}</div>
      <div class="meta" style="margin-top:8px">
        <a href="${pageLink}" target="_blank" rel="noopener">Abrir em nova aba</a>
        &nbsp;•&nbsp;
        <a href="#" data-open="${pageLink}">Visualizar ao lado</a>
      </div>
    `;
    el.querySelector('[data-open]').addEventListener('click', (ev) => {
      ev.preventDefault();
      viewerEl.src = ev.currentTarget.getAttribute('data-open');
      viewerEl.scrollIntoView({behavior:'smooth', block:'start'});
    });
    frag.appendChild(el);
  });
  resultsEl.appendChild(frag);
}

function onEnter(e){ if (e.key === 'Enter') doSearch(); }

document.getElementById('btnSearch').addEventListener('click', doSearch);
document.getElementById('btnClear').addEventListener('click', () => { qEl.value=''; doSearch(); qEl.focus(); });
qEl.addEventListener('keydown', onEnter);

indexAll();
</script>
</body>
</html>
